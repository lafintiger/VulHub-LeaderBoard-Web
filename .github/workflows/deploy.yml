name: Deploy to Heroku (Buildpacks)
on:
  push:
    branches: [ "main" ]   # change if your default branch is different
  workflow_dispatch:       # lets you run it manually, too

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Node.js for build process
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # Set Heroku config vars (environment variables) - only if not already set
      - name: Set Heroku config vars
        run: |
          echo -e "machine api.heroku.com\n  login $HEROKU_EMAIL\n  password $HEROKU_API_KEY\nmachine git.heroku.com\n  login $HEROKU_EMAIL\n  password $HEROKU_API_KEY" > ~/.netrc
          chmod 600 ~/.netrc
          curl https://cli-assets.heroku.com/install.sh | sh
          
          # Only set JWT secrets if they don't exist (prevents overwriting existing secrets)
          if ! heroku config:get JWT_SECRET -a $HEROKU_APP_NAME > /dev/null 2>&1; then
            heroku config:set JWT_SECRET="$(openssl rand -base64 32)" -a $HEROKU_APP_NAME
          fi
          if ! heroku config:get JWT_REFRESH_SECRET -a $HEROKU_APP_NAME > /dev/null 2>&1; then
            heroku config:set JWT_REFRESH_SECRET="$(openssl rand -base64 32)" -a $HEROKU_APP_NAME
          fi
          
          # Always set these
          heroku config:set NODE_ENV="production" -a $HEROKU_APP_NAME
          
          # Set CORS_ORIGIN if not already set (you should update this manually with your frontend URL)
          if ! heroku config:get CORS_ORIGIN -a $HEROKU_APP_NAME > /dev/null 2>&1; then
            heroku config:set CORS_ORIGIN="https://$HEROKU_APP_NAME.herokuapp.com" -a $HEROKU_APP_NAME
            echo "⚠️ CORS_ORIGIN set to default. Update it with your frontend URL!"
          fi
        env:
          HEROKU_API_KEY:  ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
          HEROKU_EMAIL:    ${{ secrets.HEROKU_EMAIL }}

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v4.1.9
        with:
          heroku_api_key:  ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email:    ${{ secrets.HEROKU_EMAIL }}
          # If your repo default branch is "master", set:
          # branch: master
          # If you have a Procfile in a subdirectory, set:
          # appdir: path/to/subdir

      # Run database migrations after deployment
      - name: Run database migrations
        run: |
          echo -e "machine api.heroku.com\n  login $HEROKU_EMAIL\n  password $HEROKU_API_KEY\nmachine git.heroku.com\n  login $HEROKU_EMAIL\n  password $HEROKU_API_KEY" > ~/.netrc
          chmod 600 ~/.netrc
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku run "pnpm --filter @vulhub/api prisma migrate deploy" -a $HEROKU_APP_NAME
        env:
          HEROKU_API_KEY:  ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
          HEROKU_EMAIL:    ${{ secrets.HEROKU_EMAIL }}

      # Show Heroku logs for debugging
      - name: Show Heroku logs
        if: always()
        run: |
          echo -e "machine api.heroku.com\n  login $HEROKU_EMAIL\n  password $HEROKU_API_KEY\nmachine git.heroku.com\n  login $HEROKU_EMAIL\n  password $HEROKU_API_KEY" > ~/.netrc
          chmod 600 ~/.netrc
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku logs -n 200 -a $HEROKU_APP_NAME
        env:
          HEROKU_API_KEY:  ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
          HEROKU_EMAIL:    ${{ secrets.HEROKU_EMAIL }}
